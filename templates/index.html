<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ActasEsam - Login</title>
    <link
      rel="icon"
      href="https://i.ibb.co/wRQXShk/Pica-enhance-20250116110447-removebg-preview.png"
      type="image/png"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />

    <style>
      :root {
        /* Common */
        --font-body: "Roboto", sans-serif;
        --font-heading: "Poppins", sans-serif;
        --radius-sm: 24px;
        --radius-md: 6px;
        --radius-lg: 8px;
        --transition-default: all 0.25s ease-out;
        --accent-success: #28a745;
        --accent-danger: #dc3545;

        /* Default to Dark Theme values */
        --bg-main-current: #1a1d24;
        --bg-panel-current: #252a33;
        --bg-panel-header-current: #0f1218; /* Darker for panel header */
        --bg-input-current: #353c4a;
        --bg-input-focus-current: #404859;
        --text-primary-current: #e0e0e5;
        --text-secondary-current: #a0a0b0;
        --text-placeholder-current: #707080;
        --text-button-accent-current: #1a1d24; /* Text color for accent buttons */
        --accent-interactive-current: #ffffff; /* For focused borders, icons on dark bg */
        --accent-secondary-current: #041dfa; /* A secondary accent, often blue */
        --accent-theme-current: #00bcd4; /* Main theme color (Cyan for Dark) */
        --accent-theme-darker-current: #0097a7;
        --accent-theme-lighter-current: #4dd0e1;
        --accent-theme-focus-shadow-current: rgba(
          0,
          188,
          212,
          0.3
        ); /* Cyan focus shadow */
        --border-color-current: #404855;
        --shadow-color-current: rgba(0, 0, 0, 0.2);
        --shadow-color-strong-current: rgba(0, 0, 0, 0.25);
        --logo-placeholder-color-current: var(--accent-theme-current);
        --icon-numerico-color-current: #7986cb; /* Dark theme icon color (from prefers-color-scheme) */
        --icon-LI-color-current: #a8d5c2; /* Dark theme icon color (from prefers-color-scheme) */
        --icon-numerico-hover-current: #72a4ef;
        --icon-LI-hover-current: #01f001;
        --scrollbar-thumb-current: var(--accent-theme-current);
        --scrollbar-thumb-hover-current: var(--accent-theme-darker-current);
        --button-secondary-bg-current: var(--accent-secondary-current);
        --button-secondary-hover-bg-current: var(--accent-theme-current);
        --button-secondary-hover-text-current: var(--bg-main-current);
        --admin-table-header-bg-current: var(--bg-panel-header-current);
        --admin-table-header-text-current: var(--accent-theme-current);
        --admin-button-add-user-bg-current: var(--accent-theme-current);
        --admin-button-add-user-text-current: var(--text-button-accent-current);
        --admin-button-add-user-hover-bg-current: var(
          --accent-theme-darker-current
        );
      }

      body.light-theme {
        --bg-main-current: #f4f6f8;
        --bg-panel-current: #ffffff;
        --bg-panel-header-current: #e9ecef;
        --bg-input-current: #f8f9fa;
        --bg-input-focus-current: #e9ecef;
        --text-primary-current: #212529;
        --text-secondary-current: #6c757d;
        --text-placeholder-current: #adb5bd;
        --text-button-accent-current: #ffffff;
        --accent-interactive-current: #007bff; /* Primary interactive for light theme */
        --accent-secondary-current: #0056b3; /* Darker blue for light theme */
        --accent-theme-current: #007bff; /* Main theme for light (Bootstrap Blue) */
        --accent-theme-darker-current: #0056b3;
        --accent-theme-lighter-current: #66aaff;
        --accent-theme-focus-shadow-current: rgba(
          0,
          123,
          255,
          0.3
        ); /* Blue focus shadow */
        --border-color-current: #dee2e6;
        --shadow-color-current: rgba(0, 0, 0, 0.1);
        --shadow-color-strong-current: rgba(0, 0, 0, 0.15);
        --logo-placeholder-color-current: var(--accent-theme-current);
        --icon-numerico-color-current: #6c757d;
        --icon-LI-color-current: #5a6268;
        --icon-numerico-hover-current: #0056b3;
        --icon-LI-hover-current: #28a745; /* Green for LI hover in light */
        --scrollbar-thumb-current: var(--accent-theme-current);
        --scrollbar-thumb-hover-current: var(--accent-theme-darker-current);
        --button-secondary-bg-current: var(--accent-secondary-current);
        --button-secondary-hover-bg-current: var(--accent-theme-current);
        --button-secondary-hover-text-current: #ffffff;
        --admin-table-header-bg-current: var(--bg-panel-header-current);
        --admin-table-header-text-current: var(--accent-theme-darker-current);
        --admin-button-add-user-bg-current: var(--accent-theme-current);
        --admin-button-add-user-text-current: #ffffff;
        --admin-button-add-user-hover-bg-current: var(
          --accent-theme-darker-current
        );
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      html {
        font-size: 15px;
      }
      body {
        font-family: var(--font-body);
        background-color: var(--bg-main-current);
        background-image: radial-gradient(
            circle at 15% 50%,
            color-mix(in srgb, var(--bg-panel-current) 15%, transparent) 0px,
            /* Themed gradient */ transparent 35%
          ),
          radial-gradient(
            circle at 85% 30%,
            color-mix(in srgb, var(--bg-panel-current) 15%, transparent) 0px,
            /* Themed gradient */ transparent 35%
          );
        color: var(--text-primary-current);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
        overflow-x: hidden;
        transition: background-color 0.3s ease, color 0.3s ease;
      }
      #loginContainer {
        padding: 40px 30px;
        border-radius: 10px 80px 100px;
        box-shadow: 0 4px 16px var(--shadow-color-strong-current);
        width: 100%;
        max-width: 400px;
        text-align: center;
        border: 1px solid
          color-mix(in srgb, var(--text-primary-current) 5%, transparent);
        background-color: var(--bg-panel-current); /* Themed */
      }
      #loginContainer h2 {
        font-family: var(--font-heading);
        color: var(--accent-theme-current);
        margin-bottom: 25px;
        font-size: 1.8rem;
      }
      #loginContainer .logo-placeholder {
        font-family: var(--font-heading);
        font-weight: 700;
        font-size: 1.5rem;
        color: var(--logo-placeholder-color-current);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
      }
      #loginContainer .logo-placeholder i {
        margin-right: 10px;
        font-size: 1.8rem;
        animation: pulse 2s infinite;
      }
      #loginContainer .form-group {
        margin-bottom: 20px;
        text-align: left;
      }
      #loginContainer label {
        display: block;
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--text-secondary-current);
        margin-bottom: 8px;
      }
      #loginContainer .form-input {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid var(--border-color-current);
        border-radius: 24px;
        color: var(--text-primary-current);
        font-size: 0.95rem;
        transition: var(--transition-default);
        background: var(--bg-input-current);
      }
      #loginContainer .form-input:focus {
        outline: none;
        border-color: var(--accent-theme-current);
        background: var(--bg-input-focus-current);
        box-shadow: 0 0 0 3px var(--accent-theme-focus-shadow-current);
      }
      #loginContainer .login-button {
        font-family: var(--font-heading);
        background: linear-gradient(
          45deg,
          color-mix(in srgb, var(--accent-theme-current) 70%, black),
          var(--accent-theme-current)
        );
        color: var(--text-button-accent-current);
        padding: 12px 28px;
        border: none;
        border-radius: 50px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition-default);
        width: auto;
        min-width: 150px;
        margin-top: 10px;
        box-shadow: 0 4px 15px var(--accent-theme-focus-shadow-current);
      }
      #loginContainer .login-button:hover {
        background: linear-gradient(
          45deg,
          var(--accent-theme-current),
          color-mix(in srgb, var(--accent-theme-current) 70%, black)
        );
        transform: translateY(-2px);
        box-shadow: 0 6px 20px
          color-mix(in srgb, var(--accent-theme-current) 40%, transparent);
      }
      #loginErrorMessage {
        color: var(--accent-danger);
        font-size: 0.9rem;
        margin-top: 15px;
        min-height: 1.2em;
      }

      .composition-panel {
        background-color: var(--bg-panel-current);
        width: 100%;
        max-width: 1200px;
        min-height: 90vh;
        border-radius: var(--radius-lg);
        box-shadow: 0 4px 16px var(--shadow-color-strong-current);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
        z-index: 10;
        border: 1px solid
          color-mix(in srgb, var(--text-primary-current) 5%, transparent);
      }
      #mainAppContent,
      #adminPanel {
        display: none;
      }
      .panel-background {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        overflow: hidden;
      }
      .floating-element {
        position: absolute;
        border-radius: 50%;
        background: radial-gradient(
          circle,
          color-mix(in srgb, var(--accent-theme-current) 15%, transparent) 0%,
          transparent 70%
        );
        animation: float 20s infinite linear;
      }
      .floating-element:nth-child(1) {
        width: 300px;
        height: 300px;
        top: -150px;
        left: -150px;
        animation-duration: 25s;
      }
      .floating-element:nth-child(2) {
        width: 200px;
        height: 200px;
        bottom: -100px;
        right: 10%;
        animation-duration: 20s;
        animation-delay: 5s;
      }
      .floating-element:nth-child(3) {
        width: 150px;
        height: 150px;
        top: 30%;
        right: -75px;
        animation-duration: 18s;
        animation-delay: 8s;
      }
      @keyframes float {
        0% {
          transform: translate(0, 0) rotate(0deg);
        }
        25% {
          transform: translate(10px, 15px) rotate(5deg);
        }
        50% {
          transform: translate(20px, 5px) rotate(0deg);
        }
        75% {
          transform: translate(10px, -10px) rotate(-5deg);
        }
        100% {
          transform: translate(0, 0) rotate(0deg);
        }
      }
      .panel-header {
        background-color: var(--bg-panel-header-current);
        padding: 15px 30px;
        border-bottom: 1px solid var(--border-color-current);
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: relative;
        z-index: 2;
      }
      .panel-header h1 {
        font-family: var(--font-heading);
        font-size: 1.6rem;
        font-weight: 600;
        color: var(--text-primary-current);
        letter-spacing: 0.5px;
        position: relative;
      }
      .panel-header .logo-placeholder {
        font-family: var(--font-heading);
        font-weight: 700;
        font-size: 1.3rem;
        color: var(--logo-placeholder-color-current);
        position: relative;
        display: flex;
        align-items: center;
      }
      .logo-placeholder i {
        margin-right: 10px;
        font-size: 1.5rem;
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
        }
      }

      .user-actions {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .user-actions button {
        font-family: var(--font-heading);
        background: var(--button-secondary-bg-current);
        color: var(--text-primary-current); /* Ensure good contrast */
        padding: 8px 15px;
        border: none;
        border-radius: var(--radius-sm);
        font-size: 0.85rem;
        cursor: pointer;
        transition: var(--transition-default);
      }
      .user-actions button:hover {
        background: var(--button-secondary-hover-bg-current);
        color: var(--button-secondary-hover-text-current);
      }
      .user-actions #loggedInUserDisplay {
        color: var(--text-secondary-current);
        font-size: 0.9rem;
      }
      #themeToggleBtn {
        background: transparent;
        border: 1px solid var(--border-color-current);
        color: var(--text-secondary-current);
        padding: 8px 10px; /* Make it squarish */
      }
      #themeToggleBtn:hover {
        color: var(--accent-theme-current);
        border-color: var(--accent-theme-current);
      }

      .panel-content-area {
        flex-grow: 1;
        padding: 25px 30px;
        overflow-y: auto;
        display: grid;
        grid-template-columns: 1fr;
        gap: 25px;
        position: relative;
        z-index: 2;
      }
      @media (min-width: 992px) {
        .panel-content-area {
          grid-template-columns: repeat(3, 1fr);
          grid-template-areas: "main-info main-info scoring" "observations observations scoring" "totals totals totals";
        }
        .main-info-card {
          grid-area: main-info;
        }
        .scoring-module {
          grid-area: scoring;
        }
        .observations-card {
          grid-area: observations;
        }
        .totals-summary-bar {
          grid-area: totals;
        }
      }
      .content-card {
        background: color-mix(
          in srgb,
          var(--bg-panel-current) 50%,
          var(--bg-main-current) 50%
        ); /* Themed card bg */
        padding: 25px;
        border-radius: var(--radius-md);
        border: 1px solid
          color-mix(in srgb, var(--text-primary-current) 5%, transparent);
        box-shadow: 0 2px 8px var(--shadow-color-current);
        backdrop-filter: blur(5px);
        transition: var(--transition-default);
      }
      .content-card:hover {
        box-shadow: 0 8px 24px var(--shadow-color-strong-current);
        transform: translateY(-3px);
      }
      .card-title {
        font-family: var(--font-heading);
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--accent-theme-current);
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-color-current);
        letter-spacing: 0.3px;
        display: flex;
        align-items: center;
      }
      .card-title i {
        margin-right: 10px;
        font-size: 1.2rem;
        color: var(--accent-secondary-current);
      }
      .form-group {
        margin-bottom: 18px;
        position: relative;
      }
      .form-group label {
        display: block;
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--text-secondary-current);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
      }
      .form-group label i {
        margin-right: 8px;
        font-size: 1rem;
        transition: var(--transition-default);
        color: var(--accent-theme-current);
      }
      .form-input,
      .form-textarea {
        width: 100%;
        padding: 10px 14px;
        background: transparent;
        border: none;
        border-bottom: 1px solid var(--border-color-current);
        color: var(--text-primary-current);
        font-size: 0.95rem;
        transition: var(--transition-default);
        position: relative;
      }
      .form-input:focus,
      .form-textarea:focus {
        outline: none;
        border-bottom-color: var(--accent-theme-current);
        background: transparent;
        box-shadow: 0 2px 0 var(--accent-theme-current);
      }
      .form-input::placeholder,
      .form-textarea::placeholder {
        color: var(--text-placeholder-current);
      }
      .form-input[readonly] {
        background: transparent;
        cursor: default;
        opacity: 0.8;
      }
      .form-textarea {
        min-height: 100px;
        resize: vertical;
      }
      .form-input:focus ~ .focus-indicator {
        width: 100%;
        left: 0;
      }
      .focus-indicator {
        position: absolute;
        bottom: 0;
        left: 50%;
        height: 2px;
        width: 0;
        background: var(--accent-theme-current);
        transition: var(--transition-default);
        z-index: 1;
      }
      .input-icon {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary-current);
        transition: var(--transition-default);
        pointer-events: none;
      }
      .form-input:focus ~ .input-icon {
        color: var(--accent-theme-current);
        animation: bounce 0.6s;
      }
      @keyframes bounce {
        0%,
        100% {
          transform: translateY(-50%) scale(1);
        }
        50% {
          transform: translateY(-50%) scale(1.2);
        }
      }

      .scoring-module {
        max-height: 70vh;
        overflow-y: auto;
        padding-right: 10px;
      }
      .score-entry-item {
        background-color: color-mix(
          in srgb,
          var(--bg-input-current) 60%,
          transparent
        );
        padding: 15px;
        border-radius: var(--radius-sm);
        margin-bottom: 12px;
        border-left: 3px solid var(--accent-secondary-current);
        transition: var(--transition-default);
        position: relative;
        overflow: hidden;
      }
      .score-entry-item:hover {
        border-left-color: var(--accent-theme-current);
        transform: translateX(3px);
      }
      .score-entry-item::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          color-mix(in srgb, var(--accent-theme-current) 5%, transparent) 0%,
          transparent 100%
        );
        opacity: 0;
        transition: var(--transition-default);
        z-index: 0;
      }
      .score-entry-item:hover::after {
        opacity: 1;
      }
      .score-item-header {
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--text-secondary-current);
        margin-bottom: 10px;
        position: relative;
        z-index: 1;
      }
      .score-fields {
        display: flex;
        gap: 10px;
        align-items: center;
        position: relative;
        z-index: 1;
      }
      .score-fields .form-input[type="text"][name*="N"] {
        flex-basis: 90px;
        flex-grow: 0;
        text-align: right;
        font-weight: 600;
      }
      .score-fields .form-input[type="text"][name*="LI"] {
        flex-grow: 1;
        font-style: italic;
        font-size: 0.9rem;
      }

      .totals-summary-bar {
        background: linear-gradient(
          90deg,
          color-mix(in srgb, var(--bg-panel-current) 60%, transparent),
          color-mix(
            in srgb,
            var(--bg-panel-current) 80%,
            var(--bg-main-current) 20%
          )
        );
        padding: 20px;
        border-radius: var(--radius-md);
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
        align-items: center;
        gap: 20px;
        border-top: 2px solid var(--accent-theme-current);
        position: relative;
        overflow: hidden;
      }
      .totals-summary-bar::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          45deg,
          color-mix(in srgb, var(--accent-theme-current) 5%, transparent),
          transparent 70%
        );
        z-index: 0;
      }
      .total-group {
        display: flex;
        align-items: center;
        position: relative;
        z-index: 1;
      }
      .total-group .label {
        font-size: 0.9rem;
        color: var(--text-secondary-current);
        margin-right: 10px;
      }
      .total-group .value-display {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text-primary-current);
        padding: 8px 15px;
        background: color-mix(
          in srgb,
          var(--text-primary-current) 5%,
          transparent
        );
        border-radius: var(--radius-sm);
        min-width: 100px;
        border: 1px solid transparent;
        transition: var(--transition-default);
      }
      .total-group .value-display.LI {
        font-size: 1rem;
        font-style: italic;
        font-weight: 400;
        min-width: 180px;
      }

      .panel-footer-actions {
        padding: 20px 30px;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        position: relative;
        z-index: 2;
      }
      .action-button-submit {
        font-family: var(--font-heading);
        background: linear-gradient(
          45deg,
          var(--accent-theme-current),
          var(--accent-theme-lighter-current)
        );
        color: var(--text-button-accent-current);
        padding: 12px 28px;
        border: none;
        border-radius: 50px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition-default);
        letter-spacing: 0.5px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 15px var(--accent-theme-focus-shadow-current);
        display: flex;
        align-items: center;
      }
      .action-button-submit:hover {
        background: linear-gradient(
          45deg,
          var(--accent-theme-lighter-current),
          var(--accent-theme-current)
        );
        transform: translateY(-3px);
        box-shadow: 0 6px 20px
          color-mix(in srgb, var(--accent-theme-current) 40%, transparent);
      }
      .action-button-submit:active {
        transform: translateY(1px);
        box-shadow: 0 2px 10px var(--accent-theme-focus-shadow-current);
      }
      .action-button-submit i {
        margin-right: 8px;
        font-size: 1.2rem;
        transition: var(--transition-default);
      }
      .action-button-submit:hover i {
        transform: rotate(10deg);
      }

      .scoring-module::-webkit-scrollbar,
      .panel-content-area::-webkit-scrollbar {
        width: 8px;
      }
      .scoring-module::-webkit-scrollbar-track,
      .panel-content-area::-webkit-scrollbar-track {
        background: var(--bg-panel-current);
        border-radius: var(--radius-sm);
      }
      .scoring-module::-webkit-scrollbar-thumb,
      .panel-content-area::-webkit-scrollbar-thumb {
        background-color: var(--scrollbar-thumb-current);
        border-radius: var(--radius-sm);
        border: 2px solid var(--bg-panel-current);
      }
      .scoring-module::-webkit-scrollbar-thumb:hover,
      .panel-content-area::-webkit-scrollbar-thumb:hover {
        background-color: var(--scrollbar-thumb-hover-current);
      }

      @media (max-width: 991px) {
        .panel-content-area {
          grid-template-columns: 1fr;
          grid-template-areas: "main-info" "scoring" "observations" "totals";
        }
        .scoring-module {
          max-height: none;
          overflow-y: visible;
          padding-right: 0;
        }
      }
      @media (max-width: 600px) {
        body {
          padding: 10px;
        }
        #loginContainer {
          padding: 30px 20px;
        }
        .composition-panel {
          min-height: 95vh;
        }
        .panel-header {
          padding: 15px 20px;
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }
        .panel-header h1 {
          font-size: 1.3rem;
        }
        .user-actions {
          width: 100%;
          justify-content: space-between;
        }
        .panel-content-area {
          padding: 15px 20px;
          gap: 20px;
        }
        .content-card {
          padding: 20px;
        }
        .card-title {
          font-size: 1rem;
          margin-bottom: 15px;
        }
        .totals-summary-bar {
          flex-direction: column;
          align-items: stretch;
        }
        .total-group .value-display,
        .total-group .value-display.LI {
          width: 100%;
          text-align: left;
          margin-top: 5px;
        }
        .total-group .label {
          margin-right: 0;
        }
        .panel-footer-actions {
          padding: 15px 20px;
        }
        .action-button-submit {
          width: 100%;
          justify-content: center;
        }
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .content-card,
      #adminPanel .content-card {
        animation: fadeIn 0.5s ease-out;
      }
      .main-info-card {
        animation-delay: 0.1s;
      }
      .scoring-module {
        animation-delay: 0.2s;
      }
      .observations-card {
        animation-delay: 0.3s;
      }
      .totals-summary-bar {
        animation-delay: 0.4s;
      }
      .score-entry-item {
        animation: fadeIn 0.4s ease-out;
      }
      .score-entry-item:nth-child(1) {
        animation-delay: 0.2s;
      }
      .score-entry-item:nth-child(2) {
        animation-delay: 0.25s;
      }
      .score-entry-item:nth-child(3) {
        animation-delay: 0.3s;
      }
      .score-entry-item:nth-child(4) {
        animation-delay: 0.35s;
      }
      .score-entry-item:nth-child(5) {
        animation-delay: 0.4s;
      }
      .score-entry-item:nth-child(6) {
        animation-delay: 0.45s;
      }
      .score-entry-item:nth-child(7) {
        animation-delay: 0.5s;
      }
      .score-entry-item:nth-child(8) {
        animation-delay: 0.55s;
      }
      .score-entry-item:nth-child(9) {
        animation-delay: 0.6s;
      }

      .label i {
        margin-right: 10px;
        font-size: 1.35em;
        transition: transform 0.2s ease, color 0.2s ease;
      }
      .label:hover i {
        transform: scale(1.1);
      }
      .icon-numerico {
        color: var(--icon-numerico-color-current);
      }
      .label:hover .icon-numerico {
        color: var(--icon-numerico-hover-current);
      }
      .icon-LI {
        color: var(--icon-LI-color-current);
      }
      .label:hover .icon-LI {
        color: var(--icon-LI-hover-current);
      }

      /* Admin Panel Styles */
      #adminPanel .panel-content-area {
        display: block;
      }
      #adminPanel table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
      }
      #adminPanel th,
      #adminPanel td {
        border: 1px solid var(--border-color-current);
        padding: 10px 12px;
        text-align: left;
        font-size: 0.9rem;
      }
      #adminPanel th {
        background-color: var(--admin-table-header-bg-current);
        color: var(--admin-table-header-text-current);
        font-weight: 600;
      }
      #adminPanel td {
        color: var(--text-primary-current);
      }
      #adminPanel tr:nth-child(even) td {
        background-color: color-mix(
          in srgb,
          var(--text-primary-current) 3%,
          transparent
        );
      }
      #adminPanel .action-buttons button {
        margin-right: 5px;
        padding: 6px 10px;
        font-size: 0.8rem;
        border-radius: var(--radius-sm);
        cursor: pointer;
        border: none;
        transition: var(--transition-default);
      }
      #adminPanel .btn-disable {
        background-color: var(--accent-danger);
        color: white;
      }
      #adminPanel .btn-disable:hover {
        background-color: #c82333;
      }
      #adminPanel .btn-enable {
        background-color: var(--accent-success);
        color: white;
      }
      #adminPanel .btn-enable:hover {
        background-color: #218838;
      }
      #adminPanel .btn-delete {
        background-color: var(--text-secondary-current);
        color: var(--bg-main-current);
      }
      #adminPanel .btn-delete:hover {
        background-color: var(--text-placeholder-current);
      }
      #adminPanel .btn-edit-role,
      #adminPanel .btn-reset-password {
        background-color: var(--accent-secondary-current);
        color: white;
      }
      #adminPanel .btn-edit-role:hover,
      #adminPanel .btn-reset-password:hover {
        background-color: color-mix(
          in srgb,
          var(--accent-secondary-current) 80%,
          black
        );
      }

      #adminPanel .add-user-form {
        margin-top: 20px;
        padding: 20px;
        background-color: color-mix(
          in srgb,
          var(--bg-input-current) 30%,
          transparent
        );
        border-radius: var(--radius-md);
      }
      #adminPanel .add-user-form .form-group {
        margin-bottom: 15px;
      }
      #adminPanel .add-user-form label {
        color: var(--text-secondary-current);
      }
      #adminPanel .add-user-form input[type="text"],
      #adminPanel .add-user-form input[type="password"],
      #adminPanel .add-user-form select {
        width: 30%;
        padding: 6px;
        background: var(--bg-input-current);
        border: 1px solid var(--border-color-current);
        border-radius: var(--radius-sm);
        color: var(--text-primary-current);
        font-size: 0.9rem;
      }
      #adminPanel .add-user-form input:focus,
      #adminPanel .add-user-form select:focus {
        border-color: var(--accent-theme-current);
        box-shadow: 0 0 0 2px var(--accent-theme-focus-shadow-current);
        outline: none;
      }
      #adminPanel .add-user-form button[type="submit"] {
        /* Reuses .action-button-submit styling via class, specific overrides here if needed */
        background: var(--admin-button-add-user-bg-current);
        color: var(--admin-button-add-user-text-current);
        padding: 10px 20px;
        font-weight: 600;
      }
      #adminPanel .add-user-form button[type="submit"]:hover {
        background: var(--admin-button-add-user-hover-bg-current);
      }
      .status-active {
        color: var(--accent-success);
        font-weight: bold;
      }
      .status-inactive {
        color: var(--accent-danger);
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div id="loginContainer">
      <div class="logo-placeholder">
        <i class="fas fa-graduation-cap"></i> ESAM
      </div>
      <h2>Iniciamos</h2>
      <form id="loginForm">
        <div class="form-group">
          <label for="username">Usuario:</label>
          <input
            type="text"
            id="username"
            name="username"
            class="form-input"
            required
          />
        </div>
        <div class="form-group">
          <label for="password">Contraseña:</label>
          <input
            type="password"
            id="password"
            name="password"
            class="form-input"
            required
          />
        </div>
        <button type="submit" class="login-button">Ingresar</button>
        <p id="loginErrorMessage"></p>
      </form>
    </div>

    <div id="mainAppContent">
      <div class="composition-panel">
        <div class="panel-background">
          <div class="floating-element"></div>
          <div class="floating-element"></div>
          <div class="floating-element"></div>
        </div>

        <header class="panel-header">
          <div class="logo-placeholder">
            <i class="fas fa-graduation-cap"></i> ESAM
          </div>
          <h1>Composición de Actas</h1>
          <div class="user-actions">
            <span id="loggedInUserDisplay">
              <i class="fas fa-user-circle"></i>
            </span>
            <button id="themeToggleBtn" title="Cambiar Tema">
              <i class="fas fa-sun"></i>
            </button>
            <button
              id="adminPanelBtn"
              style="display: none"
              title="Panel de Administración"
            >
              <i class="fas fa-tools"></i>
            </button>
            <button id="logoutBtn" title="Cerrar Sesión">
              <i class="fas fa-sign-out-alt"></i>
            </button>
          </div>
        </header>

        <form
          action="/generar"
          method="post"
          class="panel-content-area"
          id="actaFormApp"
        >
          <section class="content-card main-info-card">
            <h2 class="card-title">
              <i class="fas fa-file-signature"></i> Información General del Acta
            </h2>
            <div class="form-group">
              <label for="nombre_programa"
                ><i class="fas fa-book"></i> Nombre del Programa:</label
              >
              <input
                type="text"
                id="nombre_programa"
                name="NOMBRE_PROGRAMA"
                class="form-input"
                placeholder="Ej: Diplomado en Ciencias Empresariales"
                required
              />
            </div>
            <div class="form-group">
              <label for="postulante"
                ><i class="fas fa-user-graduate"></i> Postulante:</label
              >
              <input
                type="text"
                id="postulante"
                name="POSTULANTE"
                class="form-input"
                placeholder="Juan Perez"
                required
              />
            </div>
            <div class="form-group">
              <label for="evaluador"
                ><i class="fas fa-user-tie"></i> Evaluador:</label
              >
              <input
                type="text"
                id="evaluador"
                name="EVALUADOR"
                class="form-input"
                placeholder="Alexa Perez"
                required
              />
            </div>
            <div class="form-group">
              <label for="fecha"
                ><i class="fas fa-calendar-alt"></i> Fecha:</label
              >
              <input
                type="text"
                id="fecha"
                name="FECHA"
                class="form-input"
                required
              />
            </div>
            <div class="form-group">
              <label for="titulo"><i class="fas fa-heading"></i> Título:</label>
              <input
                type="text"
                id="titulo"
                name="TITULO"
                class="form-input"
                placeholder="Analisis de datos"
                required
              />
            </div>
          </section>

          <section class="content-card scoring-module">
            <h2 class="card-title">
              <i class="fas fa-medal"></i> Detalle de Calificaciones
            </h2>
            <!-- Score items 1-9 -->
            <div class="score-entry-item">
              <div class="score-item-header">Puntaje Nº 1</div>
              <div class="score-fields">
                <input
                  type="text"
                  inputmode="decimal"
                  pattern="[0-9]*[.,]?[0-9]+"
                  name="ITEM1_N"
                  class="form-input"
                  oninput="sincronizarLI(this.name)"
                  placeholder="0.00"
                />
                <input
                  type="text"
                  name="ITEM1_LI"
                  class="form-input"
                  readonly
                  placeholder="(LI)"
                />
              </div>
            </div>
            <div class="score-entry-item">
              <div class="score-item-header">Puntaje Nº 2</div>
              <div class="score-fields">
                <input
                  type="text"
                  inputmode="decimal"
                  pattern="[0-9]*[.,]?[0-9]+"
                  name="ITEM2_N"
                  class="form-input"
                  oninput="sincronizarLI(this.name)"
                  placeholder="0.00"
                />
                <input
                  type="text"
                  name="ITEM2_LI"
                  class="form-input"
                  readonly
                  placeholder="(LI)"
                />
              </div>
            </div>
            <div class="score-entry-item">
              <div class="score-item-header">Puntaje Nº 3</div>
              <div class="score-fields">
                <input
                  type="text"
                  inputmode="decimal"
                  pattern="[0-9]*[.,]?[0-9]+"
                  name="ITEM3_N"
                  class="form-input"
                  oninput="sincronizarLI(this.name)"
                  placeholder="0.00"
                />
                <input
                  type="text"
                  name="ITEM3_LI"
                  class="form-input"
                  readonly
                  placeholder="(LI)"
                />
              </div>
            </div>
            <div class="score-entry-item">
              <div class="score-item-header">Puntaje Nº 4</div>
              <div class="score-fields">
                <input
                  type="text"
                  inputmode="decimal"
                  pattern="[0-9]*[.,]?[0-9]+"
                  name="ITEM4_N"
                  class="form-input"
                  oninput="sincronizarLI(this.name)"
                  placeholder="0.00"
                />
                <input
                  type="text"
                  name="ITEM4_LI"
                  class="form-input"
                  readonly
                  placeholder="(LI)"
                />
              </div>
            </div>
            <div class="score-entry-item">
              <div class="score-item-header">Puntaje Nº 5</div>
              <div class="score-fields">
                <input
                  type="text"
                  inputmode="decimal"
                  pattern="[0-9]*[.,]?[0-9]+"
                  name="ITEM5_N"
                  class="form-input"
                  oninput="sincronizarLI(this.name)"
                  placeholder="0.00"
                />
                <input
                  type="text"
                  name="ITEM5_LI"
                  class="form-input"
                  readonly
                  placeholder="(LI)"
                />
              </div>
            </div>
            <div class="score-entry-item">
              <div class="score-item-header">Puntaje Nº 6</div>
              <div class="score-fields">
                <input
                  type="text"
                  inputmode="decimal"
                  pattern="[0-9]*[.,]?[0-9]+"
                  name="ITEM6_N"
                  class="form-input"
                  oninput="sincronizarLI(this.name)"
                  placeholder="0.00"
                />
                <input
                  type="text"
                  name="ITEM6_LI"
                  class="form-input"
                  readonly
                  placeholder="(LI)"
                />
              </div>
            </div>
            <div class="score-entry-item">
              <div class="score-item-header">Puntaje Nº 7</div>
              <div class="score-fields">
                <input
                  type="text"
                  inputmode="decimal"
                  pattern="[0-9]*[.,]?[0-9]+"
                  name="ITEM7_N"
                  class="form-input"
                  oninput="sincronizarLI(this.name)"
                  placeholder="0.00"
                />
                <input
                  type="text"
                  name="ITEM7_LI"
                  class="form-input"
                  readonly
                  placeholder="(LI)"
                />
              </div>
            </div>
            <div class="score-entry-item">
              <div class="score-item-header">Puntaje Nº 8</div>
              <div class="score-fields">
                <input
                  type="text"
                  inputmode="decimal"
                  pattern="[0-9]*[.,]?[0-9]+"
                  name="ITEM8_N"
                  class="form-input"
                  oninput="sincronizarLI(this.name)"
                  placeholder="0.00"
                />
                <input
                  type="text"
                  name="ITEM8_LI"
                  class="form-input"
                  readonly
                  placeholder="(LI)"
                />
              </div>
            </div>
            <div class="score-entry-item">
              <div class="score-item-header">Puntaje Nº 9</div>
              <div class="score-fields">
                <input
                  type="text"
                  inputmode="decimal"
                  pattern="[0-9]*[.,]?[0-9]+"
                  name="ITEM9_N"
                  class="form-input"
                  oninput="sincronizarLI(this.name)"
                  placeholder="0.00"
                />
                <input
                  type="text"
                  name="ITEM9_LI"
                  class="form-input"
                  readonly
                  placeholder="(LI)"
                />
              </div>
            </div>
          </section>

          <section class="content-card observations-card">
            <h2 class="card-title">
              <i class="fas fa-pen-fancy"></i>Observaciones
            </h2>
            <textarea
              name="OBSERVACIONES"
              class="form-textarea"
              rows="8"
              placeholder="Ingrese observaciones, o comentarios finales..."
            ></textarea>
          </section>

          <section class="totals-summary-bar">
            <div class="total-group">
              <span class="label"
                ><i class="bx bxs-report icon-numerico"></i>Total:</span
              >
              <input
                name="TOTAL_N"
                class="value-display"
                readonly
                placeholder="0.00"
              />
            </div>
            <div class="total-group">
              <span class="label"
                ><i class="bx bxs-file-doc icon-LI"></i>Literal:</span
              >
              <input
                name="TOTAL_LI"
                class="value-display LI"
                readonly
                placeholder="(en letras)"
              />
            </div>
          </section>
        </form>

        <footer class="panel-footer-actions">
          <button type="submit" form="actaFormApp" class="action-button-submit">
            <i class="fas fa-file-word" style="color: #0717ff"></i> Generar
          </button>
        </footer>
      </div>
    </div>

    <div id="adminPanel">
      <div class="composition-panel">
        <header class="panel-header">
          <div class="logo-placeholder">
            <i class="fas fa-graduation-cap"></i> ESAM
          </div>
          <h1>Admin</h1>
          <div class="user-actions">
            <button id="adminThemeToggleBtn" title="Cambiar Tema">
              <i class="fas fa-sun"></i>
            </button>
            <!-- Separate ID for admin theme toggle if needed, or share -->
            <button id="backToAppBtn" title="Volver a Actas">
              <i class="fas fa-arrow-left"></i> Atras
            </button>
          </div>
        </header>
        <div class="panel-content-area">
          <section class="content-card">
            <h2 class="card-title">
              <i class="fas fa-users-cog"></i> Gestionar Usuarios
            </h2>
            <table id="usersTable">
              <thead>
                <tr>
                  <th>Usuario</th>
                  <th>Rol</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </section>
          <section class="content-card add-user-form">
            <h2 class="card-title">
              <i class="fas fa-user-plus"></i> Agregas Usuario
            </h2>
            <form id="addUserForm">
              <div class="form-group">
                <label for="newUsername">Usuario:</label>
                <input type="text" id="newUsername" required />
              </div>
              <div class="form-group">
                <label for="newPassword">Clave</label>
                <input type="password" id="newPassword" required />
              </div>
              <div class="form-group">
                <label for="newUserRole">Rol:</label>
                <select id="newUserRole">
                  <option value="user">Usuario</option>
                  <option value="admin">Administrador</option>
                </select>
              </div>
              <button
                type="submit"
                class="action-button-submit"
                style="font-size: 0.9rem; padding: 10px 20px"
              >
                <i class="fas fa-plus-circle"></i> Usuario
              </button>
            </form>
            <p
              id="adminMessage"
              style="margin-top: 15px; font-size: 0.9rem"
            ></p>
          </section>
        </div>
      </div>
    </div>

    <script>
      function numeroALetras(num) {
        /* ... (no change) ... */ num = parseInt(num);
        if (isNaN(num)) return "";
        const unidades = [
          "cero",
          "uno",
          "dos",
          "tres",
          "cuatro",
          "cinco",
          "seis",
          "siete",
          "ocho",
          "nueve",
        ];
        const especiales = {
          10: "diez",
          11: "once",
          12: "doce",
          13: "trece",
          14: "catorce",
          15: "quince",
          16: "dieciséis",
          17: "diecisiete",
          18: "dieciocho",
          19: "diecinueve",
        };
        const decenas = [
          "",
          "",
          "veinte",
          "treinta",
          "cuarenta",
          "cincuenta",
          "sesenta",
          "setenta",
          "ochenta",
          "noventa",
        ];
        const centenas = [
          "",
          "ciento",
          "doscientos",
          "trescientos",
          "cuatrocientos",
          "quinientos",
          "seiscientos",
          "setecientos",
          "ochocientos",
          "novecientos",
        ];
        if (num === 0) return "cero";
        if (num === 100) return "cien";
        if (num < 10) return unidades[num];
        if (num < 20) return especiales[num];
        if (num < 100) {
          const d = Math.floor(num / 10),
            u = num % 10;
          if (u === 0) return decenas[d];
          if (d === 2) return "veinti" + unidades[u].toLowerCase();
          return decenas[d] + (u > 0 ? " y " + unidades[u] : "");
        }
        if (num < 1000) {
          const c = Math.floor(num / 100),
            r = num % 100;
          let pC = centenas[c];
          if (c === 1 && r === 0) return "cien";
          if (c === 1 && r > 0) pC = "ciento";
          return pC + (r > 0 ? " " + numeroALetras(r) : "");
        }
        return num.toString();
      }
      function sincronizarLI(nombreCampoNumero) {
        /* ... (no change) ... */ const campoNum =
          document.getElementsByName(nombreCampoNumero)[0];
        const nombreCampoLiteral = nombreCampoNumero.replace("_N", "_LI");
        const campoLit = document.getElementsByName(nombreCampoLiteral)[0];
        if (campoNum && campoLit) {
          let valorNumericoStr = campoNum.value.replace(",", ".");
          let vN = parseFloat(valorNumericoStr);
          if (isNaN(vN) || campoNum.value.trim() === "") {
            campoLit.value = "";
          } else {
            campoLit.value = numeroALetras(Math.floor(vN));
          }
        }
        calcularTotal();
      }
      function calcularTotal() {
        /* ... (no change) ... */ let total = 0;
        for (let i = 1; i <= 9; i++) {
          const campoNum = document.getElementsByName(`ITEM${i}_N`)[0];
          if (campoNum) {
            let valorNumericoStr = campoNum.value.replace(",", ".");
            const val = parseFloat(valorNumericoStr) || 0;
            total += val;
          }
        }
        const totalNumF = document.getElementsByName("TOTAL_N")[0];
        const totalLitF = document.getElementsByName("TOTAL_LI")[0];
        if (totalNumF) {
          totalNumF.value = total.toFixed(2).replace(".", ",");
        }
        if (totalLitF) {
          totalLitF.value = numeroALetras(Math.floor(total));
        }
      }
      function obtenerFechaFormateada() {
        /* ... (no change) ... */ const meses = [
          "enero",
          "febrero",
          "marzo",
          "abril",
          "mayo",
          "junio",
          "julio",
          "agosto",
          "septiembre",
          "octubre",
          "noviembre",
          "diciembre",
        ];
        const hoy = new Date();
        const dia = hoy.getDate();
        const mes = meses[hoy.getMonth()];
        const anio = hoy.getFullYear();
        return `${dia} de ${mes} de ${anio}`;
      }
      function initializeMainAppInterface() {
        /* ... (no change in core logic, random numbers still applied) ... */ const campoFecha =
          document.getElementById("fecha");
        if (campoFecha) campoFecha.value = obtenerFechaFormateada();
        for (let i = 1; i <= 9; i++) {
          const inputN = document.getElementsByName(`ITEM${i}_N`)[0];
          if (inputN) {
            inputN.value = (Math.floor(Math.random() * 12) + 4).toString();
            sincronizarLI(`ITEM${i}_N`);
          }
        }
        calcularTotal();
        const inputs = document.querySelectorAll(
          "#mainAppContent .form-input:not([readonly])"
        );
        inputs.forEach((input) => {
          if (
            input.parentNode &&
            !input.parentNode.querySelector(".input-icon")
          ) {
            const icon = document.createElement("i");
            icon.className = "input-icon fas fa-pen";
            input.parentNode.appendChild(icon);
          }
          if (
            input.parentNode &&
            !input.parentNode.querySelector(".focus-indicator")
          ) {
            const indicator = document.createElement("div");
            indicator.className = "focus-indicator";
            input.parentNode.appendChild(indicator);
          }
        });
        const submitBtn = document.querySelector(
          "#mainAppContent .action-button-submit"
        );
        if (submitBtn && !submitBtn.dataset.listenerAttached) {
          submitBtn.addEventListener("click", function (e) {
            const originalHTML = this.innerHTML;
            this.innerHTML =
              '<i class="fas fa-spinner fa-spin"></i> Generando Acta...';
            setTimeout(() => {
              if (this.innerHTML.includes("fa-spinner")) {
                this.innerHTML = originalHTML;
              }
            }, 4000);
          });
          submitBtn.dataset.listenerAttached = "true";
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        const loginForm = document.getElementById("loginForm");
        const loginContainer = document.getElementById("loginContainer");
        const mainAppContent = document.getElementById("mainAppContent");
        const adminPanel = document.getElementById("adminPanel");
        const loginErrorMessage = document.getElementById("loginErrorMessage");
        const logoutBtn = document.getElementById("logoutBtn");
        const adminPanelBtn = document.getElementById("adminPanelBtn");
        const backToAppBtn = document.getElementById("backToAppBtn");
        const loggedInUserDisplay = document.getElementById(
          "loggedInUserDisplay"
        );

        const themeToggleBtn = document.getElementById("themeToggleBtn");
        const adminThemeToggleBtn = document.getElementById(
          "adminThemeToggleBtn"
        );
        const body = document.body;

        // --- Theme Toggle Logic ---
        function applyTheme(theme) {
          const iconHtml =
            theme === "light"
              ? '<i class="fas fa-moon"></i>'
              : '<i class="fas fa-sun"></i>';
          if (theme === "light") {
            body.classList.add("light-theme");
          } else {
            body.classList.remove("light-theme");
          }
          if (themeToggleBtn) themeToggleBtn.innerHTML = iconHtml;
          if (adminThemeToggleBtn) adminThemeToggleBtn.innerHTML = iconHtml;
          localStorage.setItem("theme", theme);
        }

        function toggleThemeOnClick() {
          if (body.classList.contains("light-theme")) {
            applyTheme("dark");
          } else {
            applyTheme("light");
          }
        }

        if (themeToggleBtn)
          themeToggleBtn.addEventListener("click", toggleThemeOnClick);
        if (adminThemeToggleBtn)
          adminThemeToggleBtn.addEventListener("click", toggleThemeOnClick);

        const savedTheme = localStorage.getItem("theme");
        const prefersDark =
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches;

        if (savedTheme) {
          applyTheme(savedTheme);
        } else if (prefersDark) {
          applyTheme("dark");
        } else {
          applyTheme("dark");
        }
        // --- End of Theme Toggle Logic ---

        // --- Inactivity Logout Logic ---
        let inactivityTimer;
        const INACTIVITY_TIMEOUT_MS = 5 * 60 * 1000; // 5 minutes

        // ***** ESTA ES LA FUNCIÓN MODIFICADA PARA EL LOGOUT *****
        async function performLogoutActions() {
          clearTimeout(inactivityTimer);
          console.log("Attempting logout...");
          try {
            // Cambiado de POST a GET.
            // Un error 405 "Method Not Allowed" para una solicitud POST a /logout
            // a menudo significa que el servidor espera una solicitud GET para esta acción,
            // o que el endpoint POST no está configurado correctamente en el servidor.
            // Este cambio intenta usar GET.
            // Si el servidor realmente requiere POST y tiene otros problemas, esto no solucionará la causa raíz.
            const response = await fetch("/logout", { method: "GET" }); // CAMBIADO A GET

            if (!response.ok) {
              // response.ok es false para respuestas HTTP 4xx/5xx
              console.error(
                `Logout request to server failed with status: ${response.status} ${response.statusText}`
              );
              // Incluso si el logout del lado del servidor falla, redirigiremos del lado del cliente.
            } else {
              console.log(
                "Logout request to server successful (or at least accepted by server)."
              );
            }
          } catch (e) {
            // Este bloque catch es para errores de red (ej. servidor caído, sin conexión)
            console.error("Network error during logout fetch:", e);
          } finally {
            // Este bloque finally SIEMPRE se ejecutará después del try/catch.
            console.log("Redirecting to / after logout attempt.");
            // Esta línea asegura que el usuario siempre sea redirigido a la página de inicio (login) del lado del cliente.
            // La invalidación adecuada de la sesión debe ocurrir en el servidor.
            window.location.href = "/";
          }
        }
        // ***** FIN DE LA FUNCIÓN MODIFICADA PARA EL LOGOUT *****

        function autoLogout() {
          alert("Sesión cerrada por inactividad.");
          performLogoutActions();
        }

        function resetInactivityTimer() {
          clearTimeout(inactivityTimer);
          if (
            mainAppContent.style.display === "block" ||
            adminPanel.style.display === "block"
          ) {
            inactivityTimer = setTimeout(autoLogout, INACTIVITY_TIMEOUT_MS);
          }
        }
        function setupActivityListeners() {
          [
            "mousemove",
            "mousedown",
            "keypress",
            "scroll",
            "touchstart",
            "click",
          ].forEach((event) => {
            document.addEventListener(event, resetInactivityTimer, true);
          });
        }
        setupActivityListeners();
        // --- End of Inactivity Logout Logic ---

        const initialUser = "{{ logged_in_user | default('', true) }}";
        const initialRole = "{{ user_role | default('', true) }}";

        if (initialUser && initialUser !== "None" && initialUser !== "") {
          showMainApp(initialUser, initialRole);
        } else {
          showLogin();
        }

        loginForm.addEventListener("submit", async function (event) {
          /* ... (no change to login submit) ... */ event.preventDefault();
          const username = event.target.username.value;
          const password = event.target.password.value;
          loginErrorMessage.textContent = "";
          const loginButton = loginForm.querySelector(".login-button");
          loginButton.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Ingresando...';
          loginButton.disabled = true;
          try {
            const response = await fetch("/login", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ username, password }),
            });
            const data = await response.json();
            if (data.success) {
              showMainApp(data.username, data.role);
            } else {
              loginErrorMessage.textContent =
                data.message || "Error desconocido.";
              event.target.password.value = "";
            }
          } catch (error) {
            console.error("Login error:", error);
            loginErrorMessage.textContent =
              "Error de conexión con el servidor.";
          } finally {
            loginButton.innerHTML = "Ingresar";
            loginButton.disabled = false;
          }
        });

        logoutBtn.addEventListener("click", () => {
          performLogoutActions(); // Llama a la función de logout modificada
        });

        adminPanelBtn.addEventListener("click", () => {
          /* ... (no change) ... */ mainAppContent.style.display = "none";
          adminPanel.style.display = "block";
          document.title = "Admin - ActasEsam";
          loadAdminUsers();
          resetInactivityTimer();
        });
        backToAppBtn.addEventListener("click", () => {
          /* ... (no change) ... */ adminPanel.style.display = "none";
          mainAppContent.style.display = "block";
          document.title = "ActasEsam";
          resetInactivityTimer();
        });

        function showLogin() {
          /* ... (no change) ... */ loginContainer.style.display = "block";
          mainAppContent.style.display = "none";
          adminPanel.style.display = "none";
          document.title = "Login - ActasEsam";
          clearTimeout(inactivityTimer);
        }
        function showMainApp(username, role) {
          loginContainer.style.display = "none";
          mainAppContent.style.display = "block";
          adminPanel.style.display = "none";
          document.title = "ActasEsam";

          loggedInUserDisplay.innerHTML = `
    <i class="fas fa-user-circle fa-2x" style="vertical-align: middle; margin-right: 8px;"></i>
    <span style="font-size: 1.1rem;">${username}</span>
  `;

          if (role === "admin") {
            adminPanelBtn.style.display = "inline-block";
          } else {
            adminPanelBtn.style.display = "none";
          }

          initializeMainAppInterface();
          resetInactivityTimer();
        }

        // --- Admin Panel JS (no changes to its internal logic) ---
        const usersTableBody = document.querySelector("#usersTable tbody");
        const addUserForm = document.getElementById("addUserForm");
        const adminMessage = document.getElementById("adminMessage");
        async function loadAdminUsers() {
          /* ... */ adminMessage.textContent = "Cargando usuarios...";
          adminMessage.style.color = "var(--text-secondary-current)";
          try {
            const response = await fetch("/admin/users");
            if (!response.ok)
              throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            if (data.success) {
              renderUsersTable(data.users);
              adminMessage.textContent = "";
            } else {
              adminMessage.textContent =
                "Error al cargar usuarios: " + (data.message || "Desconocido");
              adminMessage.style.color = "var(--accent-danger)";
            }
          } catch (error) {
            console.error("Error fetching users:", error);
            adminMessage.textContent =
              "Error de conexión al cargar usuarios. " + error.message;
            adminMessage.style.color = "var(--accent-danger)";
          }
        }
        function renderUsersTable(users) {
          /* ... */ usersTableBody.innerHTML = "";
          if (!users || users.length === 0) {
            const row = usersTableBody.insertRow();
            const cell = row.insertCell();
            cell.colSpan = 4;
            cell.textContent = "No hay usuarios registrados.";
            cell.style.textAlign = "center";
            return;
          }
          users.forEach((user) => {
            const row = usersTableBody.insertRow();
            row.innerHTML = ` <td>${user.username}</td> <td>${
              user.role
            }</td> <td><span class="${
              user.is_active ? "status-active" : "status-inactive"
            }">${
              user.is_active ? "Activo" : "Inactivo"
            }</span></td> <td class="action-buttons"> <button class="${
              user.is_active ? "btn-disable" : "btn-enable"
            }" onclick="toggleUserStatus('${
              user.username
            }', ${!user.is_active})">${
              user.is_active ? "Desactivar" : "Activar"
            }</button> <button class="btn-delete" onclick="deleteUser('${
              user.username
            }')">Eliminar</button> <button class="btn-reset-password" onclick="promptResetPassword('${
              user.username
            }')">Reset Pass</button> <button class="btn-edit-role" onclick="promptChangeRole('${
              user.username
            }', '${user.role}')">Cambiar Rol</button> </td>`;
          });
        }
        addUserForm.addEventListener("submit", async function (event) {
          /* ... */ event.preventDefault();
          const username = document.getElementById("newUsername").value;
          const password = document.getElementById("newPassword").value;
          const role = document.getElementById("newUserRole").value;
          const submitButton = addUserForm.querySelector(
            'button[type="submit"]'
          );
          const originalButtonHTML = submitButton.innerHTML;
          submitButton.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Añadiendo...';
          submitButton.disabled = true;
          adminMessage.textContent = "";
          try {
            const response = await fetch("/admin/users/add", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ username, password, role }),
            });
            const data = await response.json();
            if (data.success) {
              adminMessage.textContent = data.message || "Usuario añadido.";
              adminMessage.style.color = "var(--accent-success)";
              addUserForm.reset();
              loadAdminUsers();
            } else {
              adminMessage.textContent =
                data.message || "Error al añadir usuario.";
              adminMessage.style.color = "var(--accent-danger)";
            }
          } catch (error) {
            console.error("Error adding user:", error);
            adminMessage.textContent = "Error de conexión al añadir usuario.";
            adminMessage.style.color = "var(--accent-danger)";
          } finally {
            submitButton.innerHTML = originalButtonHTML;
            submitButton.disabled = false;
          }
        });
        window.toggleUserStatus = async function (username, newStatus) {
          /* ... */ if (
            !confirm(
              `¿Seguro que quieres ${
                newStatus ? "activar" : "desactivar"
              } al usuario ${username}?`
            )
          )
            return;
          adminMessage.textContent = "";
          try {
            const response = await fetch("/admin/users/update", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                username: username,
                is_active: newStatus,
              }),
            });
            const data = await response.json();
            if (data.success) {
              adminMessage.textContent = data.message || "Estado actualizado.";
              adminMessage.style.color = "var(--accent-success)";
              loadAdminUsers();
            } else {
              adminMessage.textContent =
                data.message || "Error al actualizar estado.";
              adminMessage.style.color = "var(--accent-danger)";
            }
          } catch (error) {
            console.error("Error toggling status:", error);
            adminMessage.textContent = "Error de conexión al cambiar estado.";
            adminMessage.style.color = "var(--accent-danger)";
          }
        };
        window.promptResetPassword = async function (username) {
          /* ... */ const newPassword = prompt(
            `Ingrese la nueva contraseña para ${username}:`
          );
          if (newPassword === null) return;
          if (newPassword.trim() === "") {
            alert("La contraseña no puede estar vacía.");
            return;
          }
          adminMessage.textContent = "";
          try {
            const response = await fetch("/admin/users/update", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                username: username,
                new_password: newPassword,
              }),
            });
            const data = await response.json();
            if (data.success) {
              adminMessage.textContent =
                data.message || `Contraseña de ${username} actualizada.`;
              adminMessage.style.color = "var(--accent-success)";
            } else {
              adminMessage.textContent =
                data.message || "Error al resetear contraseña.";
              adminMessage.style.color = "var(--accent-danger)";
            }
          } catch (error) {
            console.error("Error resetting password:", error);
            adminMessage.textContent =
              "Error de conexión al resetear contraseña.";
            adminMessage.style.color = "var(--accent-danger)";
          }
        };
        window.promptChangeRole = async function (username, currentRole) {
          /* ... */ const newRole = prompt(
            `Cambiar rol para ${username} (actual: ${currentRole}). Ingrese 'admin' o 'user':`,
            currentRole
          );
          if (newRole === null) return;
          const trimmedNewRole = newRole.trim().toLowerCase();
          if (trimmedNewRole !== "admin" && trimmedNewRole !== "user") {
            alert("Rol inválido. Debe ser 'admin' o 'user'.");
            return;
          }
          adminMessage.textContent = "";
          try {
            const response = await fetch("/admin/users/update", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                username: username,
                new_role: trimmedNewRole,
              }),
            });
            const data = await response.json();
            if (data.success) {
              adminMessage.textContent =
                data.message || `Rol de ${username} actualizado.`;
              adminMessage.style.color = "var(--accent-success)";
              loadAdminUsers();
            } else {
              adminMessage.textContent =
                data.message || "Error al cambiar rol.";
              adminMessage.style.color = "var(--accent-danger)";
            }
          } catch (error) {
            console.error("Error changing role:", error);
            adminMessage.textContent = "Error de conexión al cambiar rol.";
            adminMessage.style.color = "var(--accent-danger)";
          }
        };
        window.deleteUser = async function (username) {
          /* ... */ if (
            !confirm(
              `¿Seguro que quieres eliminar al usuario ${username}? Esta acción no se puede deshacer.`
            )
          )
            return;
          adminMessage.textContent = "";
          try {
            const response = await fetch("/admin/users/delete", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ username: username }),
            });
            const data = await response.json();
            if (data.success) {
              adminMessage.textContent = data.message || "Usuario eliminado.";
              adminMessage.style.color = "var(--accent-success)";
              loadAdminUsers();
            } else {
              adminMessage.textContent =
                data.message || "Error al eliminar usuario.";
              adminMessage.style.color = "var(--accent-danger)";
            }
          } catch (error) {
            console.error("Error deleting user:", error);
            adminMessage.textContent = "Error de conexión al eliminar usuario.";
            adminMessage.style.color = "var(--accent-danger)";
          }
        };
      });
    </script>
  </body>
</html>
